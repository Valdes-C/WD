using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Data;
using System.Linq;
using Traceablility01.Data;
using Dapper;

namespace Traceablility01.DataReading
{
    class Report
    {
        public List<ReportData> ReportList=new List<ReportData>();
        private string sqlCommand ="with p1 as(\r\n SELECT Cast(0 AS BIT)                                       [None],\r\n       seven.prodregistration.id,\r\n       CASE Isnull(seven.prodregistration.typeid, 0)\r\n         WHEN -20090 THEN 'WZK'\r\n         WHEN -20010 THEN 'WZ'\r\n         WHEN -16250 THEN 'PWK'\r\n         WHEN -16240 THEN 'RWK'\r\n         WHEN -16170 THEN 'PW'\r\n         WHEN -16160 THEN 'RW'\r\n         WHEN -16040 THEN 'MMP'\r\n         WHEN -16030 THEN 'MMW'\r\n         WHEN -16000 THEN 'MM'\r\n         WHEN -14970 THEN 'PZK'\r\n         WHEN -14890 THEN 'PZ'\r\n       END                                                  [Type],\r\n       seven.prodregistration.created,\r\n       seven.accessuser.NAME                                [CreatedBy],\r\n       seven.prodregistration.iscanceled,\r\n       seven.prodregistration.isresource,\r\n       seven.prodregistration.isparent,\r\n       seven.prodregistration.carriertypeid,\r\n       seven.prodregistration.carrierid,\r\n       seven.prodcarrier.code                               [CarrierCode],\r\n       seven.prodregistration.feature,\r\n       seven.prodregistration.batch,\r\n       seven.warehouse.code                                 [WarehouseCode],\r\n       ( CASE\r\n           WHEN ( 1 = 0 ) THEN -1\r\n           ELSE 1\r\n         END * seven.prodregistration.quantity )            [Quantity],\r\n       seven.prodregistration.quantityunit                  [ArticleUnit],\r\n       seven.article.code                                   [ArticleCode],\r\n       seven.article.NAME                                   [ArticleName],\r\n       Isnull(seven.systemmodule.NAME, '<Nieokreślony>')   [ModuleName],\r\n       seven.prodregistration.description,\r\n       ((SELECT TOP 1 documentno\r\n         FROM   seven.document WITH (nolock)\r\n         WHERE  id = prodregistration.documentid))          [Dokument],\r\n       (SELECT TOP 1 prodorder.orderno\r\n        FROM   seven.prodregistration AS PR WITH (nolock)\r\n               JOIN mes.prodresource WITH (nolock)\r\n                 ON prodregistration.orderid = prodresource.id\r\n                    AND prodregistration.ordertypeid = prodresource.typeid\r\n               JOIN mes.prodorder\r\n                 ON prodresource.orderid = prodorder.id\r\n                    AND prodresource.ordertypeid = prodorder.typeid\r\n        WHERE  PR.id = prodregistration.id)                 [Zlecenie],\r\n       ((SELECT TOP 1 contractor.acronym\r\n         FROM   seven.document WITH (nolock)\r\n                JOIN seven.contractor\r\n                  ON contractor.id = document.contractorid\r\n         WHERE  document.id = prodregistration.documentid)) [Kontrahent],\r\n       (SELECT TOP 1 [order].orderno AS [Zamówienie]\r\n        FROM   seven.prodregistration AS PR WITH (nolock)\r\n               JOIN seven.[order] WITH (nolock)\r\n                 ON PR.orderid = [order].id\r\n                    AND PR.ordertypeid = [order].typeid\r\n        WHERE  PR.id = prodregistration.id)                 [Zamówienie],\r\n       prodregistration.mestemperature                      [Temperatura]\r\n\t\t\t, (SELECT ManufacturerBatch AS [Partia dostawcy]\r\n\t\tFROM Seven.ProdBatch\r\n\t\tWHERE Id = ProdRegistration.BatchId) [Partia dostawcy]\r\nFROM   seven.prodregistration\r\n       INNER JOIN seven.warehouse\r\n               ON ( ( seven.warehouse.id =\r\n                      seven.prodregistration.destwarehouseid )\r\n                    AND ( seven.warehouse.id <> 0 ) )\r\n       INNER JOIN seven.accessuser\r\n               ON ( seven.accessuser.id = seven.prodregistration.createdby )\r\n       INNER JOIN seven.prodcarrier\r\n               ON ( ( seven.prodcarrier.typeid =\r\n                      seven.prodregistration.carriertypeid )\r\n                    AND ( seven.prodcarrier.id =\r\n                          seven.prodregistration.carrierid ) )\r\n       LEFT OUTER JOIN seven.article\r\n                    ON ( seven.article.id = seven.prodregistration.articleid )\r\n       LEFT OUTER JOIN seven.contractor\r\n                    ON ( seven.contractor.id =\r\n                         seven.prodregistration.contractorid )\r\n       LEFT OUTER JOIN seven.systemmodule\r\n                    ON ( seven.systemmodule.id =\r\n                       seven.prodregistration.moduleid )\r\nWHERE  1 = 1\r\n       AND ( ( ( seven.prodregistration.created >= 'X1X' )\r\n               AND ( seven.prodregistration.created <= 'X2X'\r\n                   ) )\r\n             AND ( seven.prodregistration.iscanceled = 0 )\r\n             AND ( seven.prodregistration.parentid <> 0 ) )\r\n       AND (( prodregistration.destwarehouseid NOT IN ( 1, 7 )\r\n              AND prodregistration.srcwarehouseid NOT IN ( 1, 7 ) ))\r\nUNION\r\nSELECT Cast(0 AS BIT)                                       [ ],\r\n       seven.prodregistration.id,\r\n       CASE Isnull(seven.prodregistration.typeid, 0)\r\n         WHEN -20090 THEN 'WZK'\r\n         WHEN -20010 THEN 'WZ'\r\n         WHEN -16250 THEN 'PWK'\r\n         WHEN -16240 THEN 'RWK'\r\n         WHEN -16170 THEN 'PW'\r\n         WHEN -16160 THEN 'RW'\r\n         WHEN -16040 THEN 'MMP'\r\n         WHEN -16030 THEN 'MMW'\r\n         WHEN -16000 THEN 'MM'\r\n         WHEN -14970 THEN 'PZK'\r\n         WHEN -14890 THEN 'PZ'\r\n       END                                                  [Type],\r\n       seven.prodregistration.created,\r\n       seven.accessuser.NAME                                [CreatedBy],\r\n       seven.prodregistration.iscanceled,\r\n       seven.prodregistration.isresource,\r\n       seven.prodregistration.isparent,\r\n       seven.prodregistration.carriertypeid,\r\n       seven.prodregistration.carrierid,\r\n       seven.prodcarrier.code                               [CarrierCode],\r\n       seven.prodregistration.feature,\r\n       seven.prodregistration.batch,\r\n       seven.warehouse.code                                 [WarehouseCode],\r\n       ( CASE\r\n           WHEN ( 0 = 0 ) THEN -1\r\n           ELSE 1\r\n         END * seven.prodregistration.quantity )            [Quantity],\r\n       seven.prodregistration.quantityunit                  [ArticleUnit],\r\n       seven.article.code                                   [ArticleCode],\r\n       seven.article.NAME                                   [ArticleName],\r\n       Isnull(seven.systemmodule.NAME, '<Nieokreślony>')   [ModuleName],\r\n       seven.prodregistration.description,\r\n       ((SELECT TOP 1 documentno\r\n         FROM   seven.document WITH (nolock)\r\n         WHERE  id = prodregistration.documentid))          [Dokument],\r\n       (SELECT TOP 1 prodorder.orderno\r\n        FROM   seven.prodregistration AS PR WITH (nolock)\r\n               JOIN mes.prodresource WITH (nolock)\r\n                 ON prodregistration.orderid = prodresource.id\r\n                    AND prodregistration.ordertypeid = prodresource.typeid\r\n               JOIN mes.prodorder\r\n                 ON prodresource.orderid = prodorder.id\r\n                    AND prodresource.ordertypeid = prodorder.typeid\r\n        WHERE  PR.id = prodregistration.id)                 [Zlecenie],\r\n       ((SELECT TOP 1 contractor.acronym\r\n         FROM   seven.document WITH (nolock)\r\n                JOIN seven.contractor\r\n                  ON contractor.id = document.contractorid\r\n         WHERE  document.id = prodregistration.documentid)) [Kontrahent],\r\n       (SELECT TOP 1 [order].orderno AS [Zamówienie]\r\n        FROM   seven.prodregistration AS PR WITH (nolock)\r\n               JOIN seven.[order] WITH (nolock)\r\n                 ON PR.orderid = [order].id\r\n                    AND PR.ordertypeid = [order].typeid\r\n        WHERE  PR.id = prodregistration.id)                 [Zamówienie],\r\n       prodregistration.mestemperature                      [Temperatura]\r\n\t   \t\t\t, (SELECT ManufacturerBatch AS [Partia dostawcy]\r\n\t\tFROM Seven.ProdBatch\r\n\t\tWHERE Id = ProdRegistration.BatchId) [Partia dostawcy]\r\nFROM   seven.prodregistration\r\n       INNER JOIN seven.warehouse\r\n               ON ( ( seven.warehouse.id =\r\n                    seven.prodregistration.srcwarehouseid )\r\n                    AND ( seven.warehouse.id <> 0 ) )\r\n       INNER JOIN seven.accessuser\r\n               ON ( seven.accessuser.id = seven.prodregistration.createdby )\r\n       INNER JOIN seven.prodcarrier\r\n               ON ( ( seven.prodcarrier.typeid =\r\n                      seven.prodregistration.carriertypeid )\r\n                    AND ( seven.prodcarrier.id =\r\n                          seven.prodregistration.carrierid ) )\r\n       LEFT OUTER JOIN seven.article\r\n                    ON ( seven.article.id = seven.prodregistration.articleid )\r\n       LEFT OUTER JOIN seven.contractor\r\n                    ON ( seven.contractor.id =\r\n                         seven.prodregistration.contractorid )\r\n       LEFT OUTER JOIN seven.systemmodule\r\n                    ON ( seven.systemmodule.id =\r\n                       seven.prodregistration.moduleid )\r\nWHERE  1 = 1\r\n       AND ( ( ( seven.prodregistration.created >= 'X1X' )\r\n               AND ( seven.prodregistration.created <= 'X2X'\r\n                   ) )\r\n             AND ( seven.prodregistration.iscanceled = 0 )\r\n )\r\n       AND (( prodregistration.destwarehouseid NOT IN ( 1, 7 )\r\n              AND prodregistration.srcwarehouseid NOT IN ( 1, 7 ) ))\r\n)\r\nselect p1.[Created] \r\n\t  ,p1.[CreatedBy] \r\n\t  ,p1.[Batch]\r\n\t  ,p1.[WarehouseCode] \r\n\t  ,p1.[Quantity]\r\n\t  ,p1.[ArticleUnit]\r\n\t  ,p1.[ArticleCode] \r\n\t  ,p1.[ArticleName]  \r\n\t  ,p1.[Dokument] as [Document]\r\n\t  ,p1.[Kontrahent] as [Customer]\r\n\t  ,p1.[Zamówienie]  as [ShopOrder]\r\n\t  ,p1.[Partia dostawcy] as [SuplayerBatch]\r\n\t  ,a.[Zlecenie] as [ProductionOrder] \r\nfrom p1\r\ninner join (\r\n\t\t\tselect distinct  p1.[CarrierId] \r\n\t\t\t\t,p1.[Zlecenie] \r\n\t\t\tfrom p1\r\n\t\t\twhere p1.[Feature] in( \r\n\t\t\t\t\t\t\t\tselect p1.Batch \r\n\t\t\t\t\t\t\t\tfrom p1\r\n\t\t\t\t\t\t\t\twhere p1.[Dokument]='X3X'\r\n\t\t\t\t\t)\r\n\t\t\t\tand p1.[Zlecenie] is not null\r\n\t\t\t) a on a.[CarrierId] =p1.[CarrierId] \r\nwhere p1.[Dokument]='X3X'\r\norder by p1.[ArticleCode], p1.[Created] asc";
       
        private void makeData(string sql) 
        {
            using (IDbConnection connection = new SqlConnection(Helper.CnnVal("MESXL_PRD")))
            {
                ReportList = connection.Query<ReportData>($"{sql}").ToList();
            };
        }
        
        public Report(string date01,string date02,string documentPZ)
        {
            sqlCommand=sqlCommand.Replace("X1X", date01);
            sqlCommand=sqlCommand.Replace("X2X", date02);
            sqlCommand=sqlCommand.Replace("X3X", documentPZ);
            makeData(sqlCommand);
        }
    }
}
